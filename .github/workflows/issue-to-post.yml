name: Issue to Post

on:
    issues:
        types: [labeled]

jobs:
    convert-issue-to-post:
        if: github.event.label.name == 'publish'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Convert issue to markdown post
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const path = require('path');

                      const issue = context.payload.issue;
                      const title = issue.title;
                      const body = issue.body || '';
                      const author = issue.user.login;
                      const date = new Date().toISOString().split('T')[0];
                      const slug = title.toLowerCase()
                        .replace(/[^a-z0-9]+/g, '-')
                        .replace(/^-|-$/g, '');

                      // Extract tags from issue labels
                      const tags = issue.labels
                        .map(label => label.name)
                        .filter(name => name !== 'publish');

                      // Create frontmatter
                      const frontmatter = `---
                      title: "${title}"
                      date: "${date}"
                      description: "${body.substring(0, 150).replace(/"/g, '\\"')}..."
                      tags: ${JSON.stringify(tags.length > 0 ? tags : ['general'])}
                      slug: "${slug}"
                      author: "${author}"
                      ---

                      ${body}
                      `;

                      // Write to file
                      const filename = `${date}-${slug}.md`;
                      const filepath = path.join('content', 'posts', filename);
                      fs.writeFileSync(filepath, frontmatter);

                      console.log(`Created post: ${filepath}`);

                      // Close the issue
                      await github.rest.issues.update({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: issue.number,
                        state: 'closed'
                      });

                      // Add comment
                      await github.rest.issues.createComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: issue.number,
                        body: `âœ… Post created: \`${filename}\`\n\nThe post will be published in the next sync cycle.`
                      });

            - name: Commit new post
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "github-actions[bot]"
                  git add content/posts/
                  git commit -m "Add post from issue #${{ github.event.issue.number }}"
                  git push
