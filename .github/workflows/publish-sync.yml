name: Publish to Platforms

on:
    workflow_dispatch:
    schedule:
        # Run daily at 9 AM UTC
        - cron: "0 9 * * *"

jobs:
    publish:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build TypeScript
              run: npm run compile

            - name: Publish to platforms
              env:
                  DEVTO_API_KEY: ${{ secrets.DEVTO_API_KEY }}
                  HASHNODE_TOKEN: ${{ secrets.HASHNODE_TOKEN }}
                  HASHNODE_PUBLICATION_ID: ${{ secrets.HASHNODE_PUBLICATION_ID }}
                  MEDIUM_INTEGRATION_TOKEN: ${{ secrets.MEDIUM_INTEGRATION_TOKEN }}
                  WP_ACCESS_TOKEN: ${{ secrets.WP_ACCESS_TOKEN }}
                  WP_SITE: ${{ secrets.WP_SITE }}
                  BLOGGER_CLIENT_ID: ${{ secrets.BLOGGER_CLIENT_ID }}
                  BLOGGER_CLIENT_SECRET: ${{ secrets.BLOGGER_CLIENT_SECRET }}
                  BLOGGER_REFRESH_TOKEN: ${{ secrets.BLOGGER_REFRESH_TOKEN }}
                  BLOGGER_BLOG_ID: ${{ secrets.BLOGGER_BLOG_ID }}
                  TUMBLR_CONSUMER_KEY: ${{ secrets.TUMBLR_CONSUMER_KEY }}
                  TUMBLR_CONSUMER_SECRET: ${{ secrets.TUMBLR_CONSUMER_SECRET }}
                  TUMBLR_TOKEN: ${{ secrets.TUMBLR_TOKEN }}
                  TUMBLR_TOKEN_SECRET: ${{ secrets.TUMBLR_TOKEN_SECRET }}
                  TUMBLR_BLOG_IDENTIFIER: ${{ secrets.TUMBLR_BLOG_IDENTIFIER }}
                  WIX_API_TOKEN: ${{ secrets.WIX_API_TOKEN }}
                  WIX_SITE_ID: ${{ secrets.WIX_SITE_ID }}
                  WRITEAS_API_TOKEN: ${{ secrets.WRITEAS_API_TOKEN }}
                  TELEGRAPH_ACCESS_TOKEN: ${{ secrets.TELEGRAPH_ACCESS_TOKEN }}
                  MICROBLOG_TOKEN: ${{ secrets.MICROBLOG_TOKEN }}
                  MICROBLOG_ENDPOINT: ${{ secrets.MICROBLOG_ENDPOINT }}
                  SUBSTACK_API_TOKEN: ${{ secrets.SUBSTACK_API_TOKEN }}
                  SUBSTACK_PUBLICATION_ID: ${{ secrets.SUBSTACK_PUBLICATION_ID }}
                  PUBLISH_CONCURRENCY: 2
              run: npm run publish

            - name: Upload logs
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: publish-logs-${{ github.run_number }}
                  path: |
                      *.log
                  retention-days: 30

            - name: Commit updated state
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "github-actions[bot]"
                  git add .postmap.json
                  git diff --quiet && git diff --staged --quiet || git commit -m "Update publication state [skip ci]"
                  git push
